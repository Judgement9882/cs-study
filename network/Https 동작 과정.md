# Https 암호화 동작 과정

![image](https://github.com/KimSeonHui/cs-study/assets/44824456/572373a7-9a28-4baf-9242-7de1ee184184)

### 요약
> - Https는 `대칭키` + `비대칭키`를 모두 사용하는 하이브리드 조합
> - **Https 암호화 동작 과정**
>   1. 클라이언트(브라우저)가 서버로 최초 연결을 시도
>   2. 서버는 SSL 인증서를 브라우저에게 전달
>   3. 브라우저는 CA를 통해 인증서 유효성을 검사하고 세션키 발급
>   4. 브라우저는 세션키를 보관하며 서버의 공개키로 세션키를 암호화해 서버로 전송
>   5. 서버는 비밀키로 브라우저가 전달한 암호화된 세션키를 복호화해 세션키를 얻음
>   6. 클라이언트와 서버는 동일한 세션키를 공유하기 때문에 데이터를 전달할 때 세션키로 암호화/복호화를 진행

<br /><br />



## Https 동작 방식

### 1. 인증서 발급

![image](https://github.com/KimSeonHui/cs-study/assets/44824456/1739e12e-ed0c-46dd-bc88-7d8aa4eb630c)
###### `서버 = 사이트`,  `클라이언트 = 사용자` 

1.  서버는 공개키, 비밀키를 만들고, 자신의 정보와 개인키를 관리를 위해 인증 기관(CA)와 계약한다.
2. 인증 기관은 서버가 제출된 데이터를 검증하고, 인증 기관의 개인키로 사이트에서 제출한 정보를 암호화 해 인증서를 만들어 서버에 제공한다.
3. 인증 기관은 웹 브라우저에 자신의 공개키를 제공한다.

| 📌브라우저는 내부적으로 CA 리스트와 CA의 공개키를 모두 알고 있다!

<br />


### 2. SSL/TLS HandShaking

![image](https://github.com/KimSeonHui/cs-study/assets/44824456/2b0dc36f-9f97-4084-ae53-882787034fc2)


### 1) Client Hello
- 클라이언트가 서버에 처음 접속을 하게 되는 시점
- 클라이언트에서 `랜덤 데이터 생성`해 서버에 전달
- 클라이언트에서 사용할 수 있는 `암호화 방식`들을 서버에 전달

<br />

### 2) Server Hello
- client hello에 대한 응답
- 클라이언트가 전달한 `암호화 방식` 중에서 서버 쪽에서 사용할 수 있는 방식을 선택해 클라이언트로 전달
    - 채택된 암호화 방식으로 통신 진행
    - 서버에서 지원 하지 않으면 handshake X
- `랜덤 데이터` 생성해 클라이언트에 전달
- 발급 받은 `인증서 `클라이언트로 전달
    - 서비스 정보(도메인, 인증서 발급한 CA)
    - 서버의 공개키

<br />

### 3) Verify Server Certificate
- 클라이언트가 서버의 SSL 인증서를 브라우저에 있는 CA 공개키를 통해 검증
- CA에 있는 공개키를 이용해 복호화가 된다면 SSL 인증서가 해당 공개키 - 비공개키 쌍 암호화된 것
- **신뢰할 수 있는 서버!**

<br />


### 4) Client Key Exchange
- `"The premaster secret"`라는 랜덤 데이터를 생성
- 데이터를 주고 받을 때 사용하기 위한 암호화 키, `대칭키 방식`으로 사용됨
- 노출되면 안되기 때문에 `서버의 공개키`로 `암호화` 해 서버로 전송

<br />

### 6) Verify Client Certificate
- 클라이언트로부터 받은 `"The premaster secret"` 데이터를 서버의 비밀키로 복호화

<br />

### 7) Client "finished"
- 클라이언트가 클라이언트 랜덤 데이터, 서버 랜덤 데이터, "The premaster secret"를 이용해 `세션키` 생성

<br />

### 8) Server "finished"
- 서버가 클라이언트 랜덤 데이터, 서버 랜덤 데이터, "The premaster secret"를 이용해 `세션키` 생성

<br />

### 9) Exchange Message
- 핸드세이크 완료
- `세션키`를 이용해 서버와 클라이언트는 데이터를 `대칭키 방식`으로 암호화 한 후 주고 받음


#### SSL 통신은 공개키 방식, 대칭키 방식의 조합

> #### 공개키 방식
> 컴퓨터 자원을 많이 사용 > 비용⬆️     
대칭키를 서로 주고 받아야 하는데 보안상 위험

**공개키 방식**
- 속도는 느리지만, 데이터를 안전하게 주고 받을 수 있도록
- 세션키를 안전하게 공유하는 과정에서 사용

**대칭키 방식**
- 데이터 교환에는 빠른 연산 속도가 필요하기 때문에 
- 데이터 전송에서 사용

<br />

### 세션 종료
- 데이터 송수신이 끝나면 SSL 통신이 끝났다는 걸 서로에게 알려줌
- 통신에서 사용한 세션키(대칭키) 폐기

<br /><br />

## 참고 자료
- [[Network] HTTPS의 동작방식](https://inuplace.tistory.com/1086)
- [HTTPS (대칭키, 공개키, CA)](https://dolphinsarah.tistory.com/52)
- [HTTPS 동작 원리](https://dolphinsarah.tistory.com/53)
- [HTTPS란? (동작방식, 장단점)](https://rachel-kwak.github.io/2021/03/08/HTTPS.html)